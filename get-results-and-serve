#!/usr/bin/env fish


# The directories I want to copy (Slurm writes stdout to results/ whereas mlflow
# logs to mlruns/).
set results mlruns


# Local directories to store copied data in. In order for rsync not copying
# everything each time (since we adjust some paths in the fetched files) we keep
# a 1:1 image of the data on oc-appsrv01 as well as an editable copy of that
# data.
set dir (pwd)/mlruns-remote
set dir_remote $dir/remote
set dir_local $dir/localized


# Fetch data.
for r in $results
    rsync -e "ssh -F $HOME/.ssh/config" -av "ad:'/data/oc-compute02/hoffmada/prolcs/$r'" "$dir_remote/"
end


# Copy fetched data to editable copy.
rsync -av $dir_remote/ $dir_local


# Adjust absolute paths in metadata.
#
# file:///data/oc-compute02/hoffmada/prolcs/mlruns/1/3f79d6e6ffac4b8c892b2a30edc64faf/artifacts
sed -i "s@\/data\/oc-compute0.\/.*\/mlruns@$dir_local\/mlruns@" $dir_local/mlruns/**/meta.yaml


# Run mlflow server.
nix-shell --command "GUNICORN_CMD_ARGS=\"--timeout 180\" mlflow ui --backend-store-uri $dir_local/mlruns --default-artifact-root $dir_local/mlruns -p 5555"
